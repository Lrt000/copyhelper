<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>æŠ„å†™åŠ©æ‰‹ï¼ˆå¢å¼ºç‰ˆï¼‰</title>
<!-- Tailwind CSS -->
<script src="https://image.uc.cn/s/uae/g/3n/mos-production/0915/3.4.17.js"></script>
<!-- Font Awesome -->
<script src="https://image.uc.cn/s/uae/g/3n/mos-production/fontawesome-free-7.1.0-web/js/all.min.js"></script>
<link href="https://image.uc.cn/s/uae/g/3n/mos-production/fontawesome-free-7.1.0-web/css/fontawesome.min.css" rel="stylesheet"/>
<style>
        /* Custom Scrollbar for Webkit */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }

        /* Smooth transitions */
        .btn-transition {
            transition: all 0.2s ease-in-out;
        }
        .btn-transition:active {
            transform: scale(0.95);
        }

        /* Highlight Animation */
        .sentence-item {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast-enter {
            animation: slideIn 0.3s forwards;
        }
        .toast-exit {
            animation: fadeOut 0.3s forwards;
        }

        /* Mode Tabs */
        .mode-tab {
            transition: all 0.2s ease;
        }
        .mode-tab.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col items-center py-8 px-4 selection:bg-indigo-500 selection:text-white">
<!-- Main Container -->
<main class="w-full max-w-3xl space-y-6">
<!-- Header -->
<header class="text-center space-y-2">
<h1 class="text-3xl font-bold tracking-wide text-white">æŠ„å†™åŠ©æ‰‹</h1>
<p class="text-gray-400 text-sm">åˆ†å¥æœ—è¯» Â· æ…¢é€Ÿè·Ÿè¯» Â· é”®ç›˜æ§åˆ¶</p>
</header>

<!-- Input Section -->
<section class="bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-700">
    <!-- Mode Tabs -->
    <div class="flex gap-2 mb-4 border-b border-gray-700 pb-2">
        <button class="mode-tab px-4 py-2 text-sm rounded-t-lg bg-indigo-600 text-white border-b-2 border-indigo-600" data-mode="normal" id="tabNormal">
            <i class="fas fa-pen mr-1"></i>æ™®é€šæ¨¡å¼
        </button>
        <button class="mode-tab px-4 py-2 text-sm rounded-t-lg text-gray-400 hover:text-white border-b-2 border-transparent" data-mode="ai" id="tabAI">
            <i class="fas fa-robot mr-1"></i>AIåˆ†è¯æ¨¡å¼
        </button>
    </div>

    <!-- Input Area -->
    <div class="relative">
        <textarea class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-gray-100 placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none resize-none transition-all pr-24" id="articleInput" placeholder="å¯ç²˜è´´æˆ–è¾“å…¥æ–‡ç« ..." rows="4"></textarea>
        
        <!-- Copy Prompt Button (visible only in AI mode) -->
        <button class="absolute right-3 top-3 bg-purple-600 hover:bg-purple-500 text-white text-sm px-3 py-1.5 rounded-lg transition-colors hidden items-center gap-1" id="btnCopyPrompt">
            <i class="fas fa-copy"></i> å¤åˆ¶æç¤ºè¯
        </button>
    </div>

    <!-- AI Mode Helper Text -->
    <div class="mt-3 text-sm text-gray-400 hidden" id="aiHelperText">
        <div class="bg-gray-900/50 rounded-lg p-3 border border-gray-700 space-y-2">
            <p class="flex items-center gap-2 text-indigo-400">
                <i class="fas fa-info-circle"></i>
                <span>AIåˆ†è¯æ¨¡å¼ä½¿ç”¨æ­¥éª¤ï¼š</span>
            </p>
            <ol class="list-decimal list-inside space-y-1 ml-2 text-gray-300">
                <li>åœ¨è¾“å…¥æ¡†ä¸­ <span class="text-indigo-400">ç²˜è´´ä½ è¦æœ—è¯»çš„æ–‡ç« </span></li>
                <li>ç‚¹å‡»å³ä¾§ <span class="text-purple-400">ã€Œå¤åˆ¶æç¤ºè¯ã€</span> æŒ‰é’®</li>
                <li>å°†å¤åˆ¶çš„æç¤ºè¯å‘ç»™AIï¼ˆå¦‚ChatGPTï¼‰ï¼ŒAIä¼šè¿”å›å¸¦æ ‡è®°çš„æ–‡ç« </li>
                <li>æŠŠAIè¿”å›çš„ç»“æœ <span class="text-indigo-400">ç²˜è´´å›è¾“å…¥æ¡†</span></li>
                <li>ç‚¹å‡» <span class="text-green-400">ã€Œå¼€å§‹æœ—è¯»ã€</span> å³å¯æŒ‰æ ‡è®°æœ—è¯»</li>
            </ol>
            <p class="text-xs text-gray-500 mt-1 border-t border-gray-700 pt-2">
                <i class="fas fa-tag mr-1"></i>æ ‡è®°è¯´æ˜ï¼š<span class="text-yellow-500">**</span> è¯é—´åœé¡¿ Â· <span class="text-yellow-500">##</span> åˆ†å¥/é•¿åœé¡¿
            </p>
        </div>
    </div>

    <div class="mt-4 flex justify-end">
        <button class="btn-transition bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-2 px-6 rounded-lg shadow-md flex items-center gap-2" id="btnStart">
            <i class="fas fa-play"></i> å¼€å§‹æœ—è¯»
        </button>
    </div>
</section>

<!-- Settings Section -->
<section class="bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-700 space-y-6">
<!-- Row 1: Rate & Volume -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<!-- Rate Control -->
<div>
<h3 class="text-sm font-medium text-gray-300 mb-3">è¯­é€Ÿæ§åˆ¶</h3>
<div class="flex bg-gray-900 rounded-lg p-1 border border-gray-700">
<button class="rate-btn flex-1 py-1.5 text-xs rounded-md transition-colors text-gray-400 hover:text-white" data-rate="0.65">0.65x</button>
<button class="rate-btn flex-1 py-1.5 text-xs rounded-md transition-colors text-gray-400 hover:text-white" data-rate="0.75">0.75x</button>
<button class="rate-btn flex-1 py-1.5 text-xs rounded-md transition-colors bg-indigo-600 text-white shadow-sm" data-rate="1">1x</button>
<button class="rate-btn flex-1 py-1.5 text-xs rounded-md transition-colors text-gray-400 hover:text-white" data-rate="1.25">1.25x</button>
</div>
</div>
<!-- Volume Control -->
<div>
<div class="flex justify-between items-center mb-3">
<h3 class="text-sm font-medium text-gray-300">éŸ³é‡è°ƒèŠ‚</h3>
<span class="text-xs text-gray-500">é»˜è®¤: 1å€</span>
</div>
<div class="flex items-center gap-2">
<select class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2 text-sm text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" id="volumeSelect">
<option value="1">1å€ (é»˜è®¤)</option>
<option value="1.5">1.5å€</option>
<option value="2">2å€</option>
<option value="2.5">2.5å€</option>
<option value="3">3å€</option>
</select>
</div>
</div>
</div>
<!-- Row 2: Pauses -->
<div>
<div class="flex justify-between items-center mb-3">
<h3 class="text-sm font-medium text-gray-300">åœé¡¿æ—¶é•¿ (æ¯«ç§’)</h3>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="relative">
<label class="block text-xs text-gray-500 mb-1">è¯è¯­é—´åœé¡¿ (é»˜è®¤1000ms)</label>
<input class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2 text-sm text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" id="wordPauseInput" min="0" step="50" type="number" value="1000"/>
</div>
<div class="relative">
<label class="block text-xs text-gray-500 mb-1">å¥å­é—´åœé¡¿ (é»˜è®¤1200ms)</label>
<input class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2 text-sm text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" id="sentencePauseInput" min="0" step="100" type="number" value="1200"/>
</div>
</div>
</div>
<!-- Row 3: Hotkeys -->
<div>
<h3 class="text-sm font-medium text-gray-300 mb-3">å¿«æ·é”®è®¾ç½®</h3>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<!-- Prev Key -->
<div class="flex flex-col gap-1">
<label class="text-xs text-gray-500">ä¸Šä¸€å¥</label>
<input class="hotkey-input bg-gray-900 border border-gray-600 rounded-lg p-2 text-center text-sm text-indigo-400 cursor-pointer hover:border-indigo-500 transition-colors uppercase" data-action="prev" readonly="" type="text" value="A"/>
</div>
<!-- Replay Key -->
<div class="flex flex-col gap-1">
<label class="text-xs text-gray-500">é‡è¯»</label>
<input class="hotkey-input bg-gray-900 border border-gray-600 rounded-lg p-2 text-center text-sm text-indigo-400 cursor-pointer hover:border-indigo-500 transition-colors uppercase" data-action="replay" readonly="" type="text" value="S"/>
</div>
<!-- Next Key -->
<div class="flex flex-col gap-1">
<label class="text-xs text-gray-500">ä¸‹ä¸€å¥</label>
<input class="hotkey-input bg-gray-900 border border-gray-600 rounded-lg p-2 text-center text-sm text-indigo-400 cursor-pointer hover:border-indigo-500 transition-colors uppercase" data-action="next" readonly="" type="text" value="D"/>
</div>
<!-- Pause Key -->
<div class="flex flex-col gap-1">
<label class="text-xs text-gray-500">æš‚åœ/ç»§ç»­</label>
<div class="bg-gray-900 border border-gray-600 rounded-lg p-2 text-center text-sm text-gray-500 select-none">
                            Space
                        </div>
</div>
</div>
<p class="text-xs text-gray-600 mt-2">ç‚¹å‡»è¾“å…¥æ¡†åæŒ‰ä¸‹ä»»æ„é”®è¿›è¡Œç»‘å®šã€‚æš‚åœé»˜è®¤ä¸ºç©ºæ ¼ã€‚</p>
</div>
</section>

<!-- Display & Control Section -->
<section class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 overflow-hidden flex flex-col h-[400px]">
<!-- Progress Bar -->
<div class="bg-gray-900/50 p-3 border-b border-gray-700 flex justify-between items-center">
<span class="text-sm font-medium text-indigo-400" id="progressText">ç­‰å¾…è¾“å…¥...</span>
<button class="text-xs text-gray-400 hover:text-white transition-colors flex items-center gap-1" id="btnRefresh" title="åº”ç”¨æ–°å‚æ•°å¹¶é‡è¯»å½“å‰å¥">
<i class="fas fa-sync-alt"></i> åˆ·æ–°å‚æ•°
                </button>
</div>
<!-- Sentence List -->
<div class="flex-1 overflow-y-auto p-4 space-y-3 relative" id="sentenceContainer">
<div class="absolute inset-0 flex items-center justify-center text-gray-500 text-sm" id="emptyState">
                    è¯·åœ¨ä¸Šæ–¹è¾“å…¥æ–‡ç« å¹¶ç‚¹å‡»â€œå¼€å§‹æœ—è¯»â€
                </div>
<!-- Sentences will be injected here -->
</div>
<!-- Controls -->
<div class="bg-gray-900/80 p-4 border-t border-gray-700">
<div class="flex justify-center items-center gap-4 md:gap-8">
<button class="btn-transition group flex flex-col items-center gap-1 text-gray-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed" id="btnPrev">
<div class="w-10 h-10 rounded-full bg-gray-800 border border-gray-600 flex items-center justify-center group-hover:border-indigo-500 group-hover:bg-indigo-900/30 transition-all">
<i class="fas fa-step-backward"></i>
</div>
<span class="text-xs">ä¸Šä¸€å¥</span>
</button>
<button class="btn-transition group flex flex-col items-center gap-1 text-gray-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed" id="btnReplay">
<div class="w-10 h-10 rounded-full bg-gray-800 border border-gray-600 flex items-center justify-center group-hover:border-indigo-500 group-hover:bg-indigo-900/30 transition-all">
<i class="fas fa-undo"></i>
</div>
<span class="text-xs">é‡è¯»</span>
</button>
<button class="btn-transition group flex flex-col items-center gap-1 text-indigo-400 hover:text-indigo-300 disabled:opacity-30 disabled:cursor-not-allowed" id="btnPause">
<div class="w-14 h-14 rounded-full bg-indigo-600 shadow-lg shadow-indigo-900/50 flex items-center justify-center group-hover:scale-105 transition-all">
<i class="fas fa-pause text-xl" id="iconPause"></i>
</div>
<span class="text-xs" id="textPause">æš‚åœ</span>
</button>
<button class="btn-transition group flex flex-col items-center gap-1 text-gray-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed" id="btnNext">
<div class="w-10 h-10 rounded-full bg-gray-800 border border-gray-600 flex items-center justify-center group-hover:border-indigo-500 group-hover:bg-indigo-900/30 transition-all">
<i class="fas fa-step-forward"></i>
</div>
<span class="text-xs">ä¸‹ä¸€å¥</span>
</button>
</div>
</div>
</section>
<footer class="text-center text-gray-600 text-xs py-4">
            Â© 2026 æŠ„å†™åŠ©æ‰‹ï¼ˆå¢å¼ºç‰ˆï¼‰. All rights reserved.
        </footer>
</main>
<!-- Toast Container -->
<div class="fixed bottom-10 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none" id="toastContainer"></div>
<script>
        /**
         * State Management
         */
        const state = {
            sentences: [],
            currentIndex: -1,
            isPlaying: false,
            isPaused: false,
            currentWords: [],
            currentWordIndex: 0,
            mode: 'normal', // 'normal' æˆ– 'ai'
            aiStep: 1, // AIæ¨¡å¼æ­¥éª¤ï¼š1=ç­‰å¾…ç²˜è´´æ–‡ç« ï¼Œ2=ç­‰å¾…ç²˜è´´AIç»“æœ
            tempArticle: '', // æš‚å­˜çš„ç”¨æˆ·æ–‡ç« ï¼ˆç”¨äºç”Ÿæˆæç¤ºè¯ï¼‰
            config: {
                rate: 1,
                wordPause: 1000,      // é»˜è®¤1000ms
                sentencePause: 1200,  // é»˜è®¤1200ms
                volume: 1,
                hotkeys: {
                    prev: 'a',
                    replay: 's',
                    next: 'd'
                }
            },
            stopSignal: false,
            pauseSignal: false,
            timers: []
        };

        /**
         * DOM Elements
         */
        const els = {
            input: document.getElementById('articleInput'),
            btnStart: document.getElementById('btnStart'),
            sentenceContainer: document.getElementById('sentenceContainer'),
            emptyState: document.getElementById('emptyState'),
            progressText: document.getElementById('progressText'),
            btnPrev: document.getElementById('btnPrev'),
            btnReplay: document.getElementById('btnReplay'),
            btnPause: document.getElementById('btnPause'),
            btnNext: document.getElementById('btnNext'),
            btnRefresh: document.getElementById('btnRefresh'),
            btnCopyPrompt: document.getElementById('btnCopyPrompt'),
            iconPause: document.getElementById('iconPause'),
            textPause: document.getElementById('textPause'),
            rateBtns: document.querySelectorAll('.rate-btn'),
            volumeSelect: document.getElementById('volumeSelect'),
            wordPauseInput: document.getElementById('wordPauseInput'),
            sentencePauseInput: document.getElementById('sentencePauseInput'),
            hotkeyInputs: document.querySelectorAll('.hotkey-input'),
            toastContainer: document.getElementById('toastContainer'),
            tabNormal: document.getElementById('tabNormal'),
            tabAI: document.getElementById('tabAI'),
            aiHelperText: document.getElementById('aiHelperText')
        };

        /**
         * Utility Functions
         */
        function showToast(message, duration = 2000) {
            const toast = document.createElement('div');
            toast.className = 'bg-gray-800 text-white px-4 py-2 rounded-lg shadow-xl border border-gray-700 text-sm flex items-center gap-2 toast-enter';
            toast.innerHTML = `<i class="fas fa-info-circle text-indigo-400"></i> ${message}`;
            
            els.toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                toast.addEventListener('animationend', () => toast.remove());
            }, duration);
        }

        function clearAllTimers() {
            state.timers.forEach(id => clearTimeout(id));
            state.timers = [];
        }

        function forceStopAllSpeech() {
            state.stopSignal = true;
            state.pauseSignal = false;
            clearAllTimers();
            window.speechSynthesis.cancel();
            
            while (window.speechSynthesis.speaking || window.speechSynthesis.pending) {
                window.speechSynthesis.cancel();
            }
            
            setTimeout(() => {
                window.speechSynthesis.cancel();
            }, 50);
            
            state.isPlaying = false;
            state.isPaused = false;
            updatePauseButtonUI();
        }

        function updatePauseButtonUI() {
            if (state.isPaused) {
                els.iconPause.className = 'fas fa-play text-xl';
                els.textPause.textContent = 'ç»§ç»­';
            } else {
                els.iconPause.className = 'fas fa-pause text-xl';
                els.textPause.textContent = 'æš‚åœ';
            }
        }

        function updateProgress() {
            if (state.sentences.length === 0) {
                els.progressText.textContent = 'ç­‰å¾…è¾“å…¥...';
                return;
            }
            const current = state.currentIndex + 1;
            const total = state.sentences.length;
            els.progressText.textContent = `å½“å‰å¥å­ï¼šç¬¬ ${current} / ${total} å¥`;
        }

        function highlightSentence(index, shouldScroll = false) {
            const prev = document.querySelector('.sentence-active');
            if (prev) {
                prev.classList.remove('sentence-active', 'bg-indigo-900/40', 'border-l-4', 'border-indigo-500');
                prev.classList.add('border-l-4', 'border-transparent');
            }

            const current = document.getElementById(`sent-${index}`);
            if (current) {
                current.classList.add('sentence-active', 'bg-indigo-900/40', 'border-indigo-500');
                current.classList.remove('border-transparent');
                
                // ä»…å½“ shouldScroll ä¸º true æ—¶æ‰æ»šåŠ¨ï¼ˆç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»ï¼‰
                if (shouldScroll) {
                    current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        /**
         * Mode Switching
         */
        function switchMode(mode) {
            state.mode = mode;
            
            // Update tab UI
            if (mode === 'normal') {
                els.tabNormal.classList.add('active', 'bg-indigo-600', 'text-white', 'border-indigo-600');
                els.tabNormal.classList.remove('text-gray-400', 'border-transparent');
                els.tabAI.classList.remove('active', 'bg-indigo-600', 'text-white', 'border-indigo-600');
                els.tabAI.classList.add('text-gray-400', 'border-transparent');
                
                // Hide AI elements
                els.btnCopyPrompt.classList.add('hidden');
                els.aiHelperText.classList.add('hidden');
                
                // Reset input placeholder
                els.input.placeholder = 'å¯ç²˜è´´æˆ–è¾“å…¥æ–‡ç« ...';
                
                // Reset AI step
                state.aiStep = 1;
            } else {
                els.tabAI.classList.add('active', 'bg-indigo-600', 'text-white', 'border-indigo-600');
                els.tabAI.classList.remove('text-gray-400', 'border-transparent');
                els.tabNormal.classList.remove('active', 'bg-indigo-600', 'text-white', 'border-indigo-600');
                els.tabNormal.classList.add('text-gray-400', 'border-transparent');
                
                // Show AI elements
                els.btnCopyPrompt.classList.remove('hidden');
                els.aiHelperText.classList.remove('hidden');
                
                // Set to step 1
                state.aiStep = 1;
                els.input.placeholder = 'ğŸ“ ç¬¬1æ­¥ï¼šè¯·ç²˜è´´ä½ è¦æœ—è¯»çš„æ–‡ç« ';
                els.input.value = ''; // Clear input
            }
        }

        /**
         * Generate AI Prompt
         */
        function generatePrompt(article) {
            return `è¯·å¯¹ä»¥ä¸‹æ–‡ç« è¿›è¡Œæ™ºèƒ½åˆ†è¯æœ—è¯»æ ‡è®°ã€‚è§„åˆ™å¦‚ä¸‹ï¼š
1. åœ¨éœ€è¦çŸ­æš‚åœé¡¿çš„ä½ç½®æ’å…¥ä¸¤ä¸ªæ˜Ÿå·ï¼š**
2. åœ¨éœ€è¦è¾ƒé•¿åœé¡¿æˆ–åˆ†æ®µçš„ä½ç½®æ’å…¥ä¸¤ä¸ªäº•å·ï¼š##
3. ä¿æŒåŸæ–‡æ‰€æœ‰æ–‡å­—å’Œæ ‡ç‚¹ä¸å˜

æ–‡ç« å†…å®¹ï¼š
${article}`;
        }

        /**
         * Parse AI Markers - å­˜å‚¨å¸¦æ ‡è®°åŸæ–‡ç”¨äºåˆ†è¯ï¼Œè¿”å›å»æ ‡è®°æ–‡æœ¬ç”¨äºæ˜¾ç¤º
         */
        function parseAIMarkers(text) {
            // Split by ## first (sentence breaks)
            const sentences = text.split('##').filter(s => s.trim());
            
            return sentences.map(sentence => {
                // ä¿å­˜å¸¦æ ‡è®°çš„åŸå§‹æ–‡æœ¬ï¼ˆç”¨äºåˆ†è¯ï¼‰
                const rawText = sentence;
                // å»é™¤ ** æ ‡è®°ï¼Œç”¨äºæ˜¾ç¤º
                const displayText = sentence.replace(/\*\*/g, '');
                // Split by ** (word pauses)
                const words = sentence.split('**').filter(w => w.trim());
                
                return {
                    rawText: rawText,        // å¸¦æ ‡è®°çš„åŸæ–‡
                    text: displayText,       // å»æ ‡è®°çš„æ˜¾ç¤ºæ–‡æœ¬
                    words: words.length > 0 ? words : [displayText],
                    hasMarkers: true
                };
            });
        }

        /**
         * Text Processing
         */
        function processText() {
            const text = els.input.value.trim();
            if (!text) {
                showToast('è¯·è¾“å…¥æ–‡ç« å†…å®¹');
                return null;
            }

            // AI Mode: Parse markers
            if (state.mode === 'ai') {
                if (text.includes('**') || text.includes('##')) {
                    return parseAIMarkers(text);
                } else {
                    showToast('AIæ¨¡å¼ä¸‹ï¼Œè¯·ç²˜è´´å¸¦ ** å’Œ ## æ ‡è®°çš„æ–‡ç« ');
                    return null;
                }
            }

            // Normal Mode: Split by punctuation
            const rawSentences = text.split(/([ã€‚ï¼Œï¼›ï¼Ÿï¼])/);
            const result = [];
            let tempBuffer = '';

            for (let i = 0; i < rawSentences.length; i++) {
                const chunk = rawSentences[i];
                if (/[ã€‚ï¼Œï¼›ï¼Ÿï¼]/.test(chunk)) {
                    tempBuffer += chunk;
                    if (tempBuffer.trim().length > 0) {
                        result.push(tempBuffer.trim());
                        tempBuffer = '';
                    }
                } else {
                    tempBuffer += chunk;
                }
            }
            
            if (tempBuffer.trim().length > 0) {
                result.push(tempBuffer.trim());
            }

            if (result.length === 0) {
                showToast('æ— æ³•è¯†åˆ«æœ‰æ•ˆå¥å­ï¼Œè¯·æ£€æŸ¥è¾“å…¥');
                return null;
            }

            return result;
        }

        function renderSentences(sentences) {
            els.sentenceContainer.innerHTML = '';
            els.emptyState.style.display = 'none';

            sentences.forEach((sent, index) => {
                const div = document.createElement('div');
                div.id = `sent-${index}`;
                div.className = 'sentence-item p-3 rounded-lg border-l-4 border-transparent text-gray-300 text-base leading-relaxed cursor-pointer hover:bg-gray-700/50 transition-colors';
                
                // å¦‚æœæ˜¯ AI æ¨¡å¼ä¸”æœ‰æ ‡è®°ï¼Œæ˜¾ç¤ºå»æ ‡è®°çš„æ–‡æœ¬
                if (typeof sent === 'object' && sent.hasMarkers) {
                    div.textContent = sent.text;  // ä½¿ç”¨å»æ ‡è®°çš„æ˜¾ç¤ºæ–‡æœ¬
                } else {
                    div.textContent = sent;
                }
                
                div.onclick = () => {
                    if (state.isPlaying || state.isPaused) {
                        forceStopAllSpeech();
                        setTimeout(() => {
                            state.currentIndex = index;
                            highlightSentence(index, true); // ç”¨æˆ·ç‚¹å‡»ï¼Œä¼ å…¥ true å…è®¸æ»šåŠ¨
                            updateProgress();
                            playCurrentSentence();
                        }, 150);
                    } else {
                        state.currentIndex = index;
                        highlightSentence(index, true); // ç”¨æˆ·ç‚¹å‡»ï¼Œä¼ å…¥ true å…è®¸æ»šåŠ¨
                        updateProgress();
                        playCurrentSentence();
                    }
                };
                els.sentenceContainer.appendChild(div);
            });
        }

        function getWords(sentence) {
            // å¦‚æœæ˜¯ AI æ¨¡å¼çš„å¯¹è±¡ï¼Œä½¿ç”¨å…¶ words æ•°ç»„ï¼ˆå·²æŒ‰ ** åˆ†å¥½ï¼‰
            if (typeof sentence === 'object' && sentence.words) {
                return sentence.words;
            }
            
            // æ™®é€šæ¨¡å¼åˆ†è¯
            const words = [];
            let currentWord = '';
            
            for (let i = 0; i < sentence.length; i++) {
                const char = sentence[i];
                if (/[ã€‚ï¼Œï¼›ï¼Ÿï¼ã€]/.test(char)) {
                    if (currentWord) {
                        words.push(currentWord);
                        currentWord = '';
                    }
                    words.push(char);
                } else {
                    currentWord += char;
                }
            }
            
            if (currentWord) {
                words.push(currentWord);
            }
            
            return words.length > 0 ? words : [sentence];
        }

        function playWordSequence(words, wordIndex) {
            if (state.stopSignal) return;
            if (state.pauseSignal) return;

            if (window.speechSynthesis.speaking || window.speechSynthesis.pending) {
                window.speechSynthesis.cancel();
            }

            if (wordIndex >= words.length) {
                if (!state.stopSignal && !state.pauseSignal) {
                    const timer = setTimeout(() => {
                        if (!state.stopSignal && !state.pauseSignal) {
                            playNextSentence();
                        }
                    }, state.config.sentencePause);
                    state.timers.push(timer);
                }
                return;
            }

            state.currentWordIndex = wordIndex;

            const utterance = new SpeechSynthesisUtterance(words[wordIndex]);
            utterance.rate = state.config.rate;
            utterance.volume = Math.min(state.config.volume, 1);
            utterance.lang = 'zh-CN';

            utterance.onstart = () => {
                if (state.stopSignal) {
                    window.speechSynthesis.cancel();
                }
            };

            utterance.onend = () => {
                if (state.stopSignal || state.pauseSignal) return;
                
                const timer = setTimeout(() => {
                    playWordSequence(words, wordIndex + 1);
                }, state.config.wordPause);
                state.timers.push(timer);
            };

            utterance.onerror = (e) => {
                console.error('Speech error', e);
                if (state.stopSignal || state.pauseSignal) return;
                
                const timer = setTimeout(() => {
                    playWordSequence(words, wordIndex + 1);
                }, state.config.wordPause);
                state.timers.push(timer);
            };

            if (!state.stopSignal) {
                window.speechSynthesis.speak(utterance);
            }
        }

        function playCurrentSentence() {
            if (state.currentIndex < 0 || state.currentIndex >= state.sentences.length) return;

            forceStopAllSpeech();
            
            setTimeout(() => {
                state.stopSignal = false;
                state.pauseSignal = false;
                state.isPlaying = true;
                state.isPaused = false;
                
                const sentence = state.sentences[state.currentIndex];
                state.currentWords = getWords(sentence);
                state.currentWordIndex = 0;
                
                highlightSentence(state.currentIndex, false); // è‡ªåŠ¨æ’­æ”¾ï¼Œä¸æ»šåŠ¨
                updateProgress();
                updatePauseButtonUI();

                els.btnPrev.disabled = false;
                els.btnReplay.disabled = false;
                els.btnNext.disabled = false;
                els.btnPause.disabled = false;
                
                playWordSequence(state.currentWords, 0);
            }, 100);
        }

        function playNextSentence() {
            if (state.currentIndex + 1 >= state.sentences.length) {
                state.isPlaying = false;
                state.isPaused = false;
                updatePauseButtonUI();
                showToast('æœ—è¯»ç»“æŸ');
                
                els.btnPrev.disabled = false;
                els.btnReplay.disabled = true;
                els.btnNext.disabled = true;
                els.btnPause.disabled = true;
                return;
            }
            
            forceStopAllSpeech();
            
            setTimeout(() => {
                state.currentIndex++;
                playCurrentSentence(); // playCurrentSentence å†…éƒ¨ä¼šè°ƒç”¨ highlightSentence ä¸”ä¼  false
            }, 150);
        }

        function playPrevSentence() {
            if (state.currentIndex <= 0) {
                showToast('å·²ç»æ˜¯ç¬¬ä¸€å¥äº†');
                return;
            }
            
            forceStopAllSpeech();
            
            setTimeout(() => {
                state.currentIndex--;
                playCurrentSentence(); // playCurrentSentence å†…éƒ¨ä¼šè°ƒç”¨ highlightSentence ä¸”ä¼  false
            }, 150);
        }

        /**
         * Event Handlers
         */

        // Mode Tabs
        els.tabNormal.addEventListener('click', () => switchMode('normal'));
        els.tabAI.addEventListener('click', () => switchMode('ai'));

        // Copy Prompt Button - å¼ºåŒ–ç‰ˆï¼ŒåŒé‡ä¿éšœ
        els.btnCopyPrompt.addEventListener('click', async () => {
            const text = els.input.value.trim();
            
            if (!text) {
                showToast('è¯·å…ˆç²˜è´´ä½ è¦æœ—è¯»çš„æ–‡ç« ');
                return;
            }

            // Save article
            state.tempArticle = text;
            const prompt = generatePrompt(text);
            
            try {
                // æ–¹æ³•1ï¼šä½¿ç”¨ Clipboard API
                await navigator.clipboard.writeText(prompt);
                showToast('âœ… æç¤ºè¯å·²å¤åˆ¶ï¼è¯·å‘ç»™AI');
                
                // Move to step 2
                state.aiStep = 2;
                els.input.placeholder = 'ğŸ¤– ç¬¬2æ­¥ï¼šè¯·å°†AIè¿”å›çš„ç»“æœç²˜è´´è‡³æ­¤';
                els.input.value = ''; // Clear input
            } catch (err) {
                // æ–¹æ³•2ï¼šé™çº§æ–¹æ¡ˆ - ä½¿ç”¨ execCommand
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = prompt;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        showToast('âœ… æç¤ºè¯å·²å¤åˆ¶ï¼è¯·å‘ç»™AI');
                        state.aiStep = 2;
                        els.input.placeholder = 'ğŸ¤– ç¬¬2æ­¥ï¼šè¯·å°†AIè¿”å›çš„ç»“æœç²˜è´´è‡³æ­¤';
                        els.input.value = '';
                    } else {
                        showToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                        // æ˜¾ç¤ºæç¤ºè¯è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
                        showPromptInDialog(prompt);
                    }
                } catch (e) {
                    showToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    showPromptInDialog(prompt);
                }
            }
        });

        // æ‰‹åŠ¨å¤åˆ¶è¾…åŠ©å‡½æ•°
        function showPromptInDialog(prompt) {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 max-w-2xl w-full mx-4 border border-gray-700">
                    <h3 class="text-lg font-medium text-white mb-4">å¤åˆ¶æç¤ºè¯</h3>
                    <textarea class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-gray-100 text-sm" rows="8" readonly>${prompt}</textarea>
                    <div class="flex justify-end mt-4">
                        <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg" onclick="this.closest('.fixed').remove()">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        // Start Button
        els.btnStart.addEventListener('click', () => {
            // Check if we're in AI mode step 2 with empty input
            if (state.mode === 'ai' && state.aiStep === 2 && !els.input.value.trim()) {
                showToast('è¯·å…ˆç²˜è´´AIè¿”å›çš„ç»“æœ');
                return;
            }

            const sentences = processText();
            if (sentences) {
                forceStopAllSpeech();
                
                setTimeout(() => {
                    state.sentences = sentences;
                    state.currentIndex = 0;
                    renderSentences(sentences);
                    playCurrentSentence(); // playCurrentSentence å†…éƒ¨ä¼šè°ƒç”¨ highlightSentence ä¸”ä¼  false
                }, 150);
            }
        });

        // Refresh Button
        els.btnRefresh.addEventListener('click', () => {
            updateConfigFromUI();
            
            if (state.sentences.length > 0 && state.currentIndex >= 0) {
                forceStopAllSpeech();
                
                setTimeout(() => {
                    playCurrentSentence();
                    showToast('å·²åˆ·æ–°å‚æ•°å¹¶é‡æ–°æœ—è¯»');
                }, 150);
            } else {
                showToast('è¯·å…ˆå¼€å§‹æœ—è¯»');
            }
        });

        // Control Buttons
        els.btnPrev.addEventListener('click', () => {
            if (state.sentences.length === 0) return;
            forceStopAllSpeech();
            setTimeout(() => playPrevSentence(), 150);
        });

        els.btnReplay.addEventListener('click', () => {
            if (state.sentences.length === 0) return;
            forceStopAllSpeech();
            setTimeout(() => playCurrentSentence(), 150);
        });

        els.btnNext.addEventListener('click', () => {
            if (state.sentences.length === 0) return;
            forceStopAllSpeech();
            setTimeout(() => playNextSentence(), 150);
        });

        els.btnPause.addEventListener('click', () => {
            if (!state.isPlaying && !state.isPaused) return;

            if (state.isPaused) {
                state.isPaused = false;
                state.pauseSignal = false;
                state.stopSignal = false;
                updatePauseButtonUI();
                
                if (state.currentWords && state.currentWordIndex < state.currentWords.length) {
                    playWordSequence(state.currentWords, state.currentWordIndex);
                } else {
                    playCurrentSentence();
                }
            } else {
                state.isPaused = true;
                state.pauseSignal = true;
                window.speechSynthesis.cancel();
                clearAllTimers();
                updatePauseButtonUI();
            }
        });

        // Settings UI Logic
        function updateConfigFromUI() {
            state.config.wordPause = parseInt(els.wordPauseInput.value) || 1000;
            state.config.sentencePause = parseInt(els.sentencePauseInput.value) || 1200;
            state.config.volume = parseFloat(els.volumeSelect.value) || 1;
        }

        els.rateBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                els.rateBtns.forEach(b => {
                    b.classList.remove('bg-indigo-600', 'text-white', 'shadow-sm');
                    b.classList.add('text-gray-400');
                });
                e.target.classList.remove('text-gray-400');
                e.target.classList.add('bg-indigo-600', 'text-white', 'shadow-sm');
                state.config.rate = parseFloat(e.target.dataset.rate);
            });
        });

        els.volumeSelect.addEventListener('change', () => {
            state.config.volume = parseFloat(els.volumeSelect.value);
        });

        // Hotkey Binding Logic
        let bindingInput = null;

        els.hotkeyInputs.forEach(input => {
            input.addEventListener('focus', () => {
                bindingInput = input;
                input.value = '...';
                input.classList.add('animate-pulse', 'border-indigo-500');
            });

            input.addEventListener('blur', () => {
                if (bindingInput === input) {
                    const action = input.dataset.action;
                    input.value = state.config.hotkeys[action].toUpperCase();
                    input.classList.remove('animate-pulse', 'border-indigo-500');
                    bindingInput = null;
                }
            });

            input.addEventListener('keydown', (e) => {
                if (bindingInput === input) {
                    e.preventDefault();
                    const key = e.key.toLowerCase();
                    
                    if (key === ' ') {
                        showToast('ç©ºæ ¼é”®å·²ä¿ç•™ç”¨äºæš‚åœ');
                        return;
                    }

                    const action = input.dataset.action;
                    state.config.hotkeys[action] = key;
                    
                    input.value = key.toUpperCase();
                    input.classList.remove('animate-pulse', 'border-indigo-500');
                    input.blur();
                    bindingInput = null;
                    
                    showToast(`å·²ç»‘å®š: ${key.toUpperCase()}`);
                }
            });
        });

        // Global Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            const activeElement = document.activeElement;
            
            if (bindingInput) return;
            
            if (activeElement && (activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT')) {
                if (key === ' ') {
                    e.preventDefault();
                    els.btnPause.click();
                }
                return;
            }

            if (key === ' ') {
                e.preventDefault();
                els.btnPause.click();
                return;
            }

            if (key === state.config.hotkeys.prev) {
                e.preventDefault();
                els.btnPrev.click();
            } else if (key === state.config.hotkeys.replay) {
                e.preventDefault();
                els.btnReplay.click();
            } else if (key === state.config.hotkeys.next) {
                e.preventDefault();
                els.btnNext.click();
            }
        });

        document.addEventListener('click', (e) => {
            if (bindingInput && !e.target.classList.contains('hotkey-input')) {
                const action = bindingInput.dataset.action;
                bindingInput.value = state.config.hotkeys[action].toUpperCase();
                bindingInput.classList.remove('animate-pulse', 'border-indigo-500');
                bindingInput.blur();
                bindingInput = null;
            }
        });

        // Initialize UI State
        function init() {
            els.btnPrev.disabled = true;
            els.btnReplay.disabled = true;
            els.btnNext.disabled = true;
            els.btnPause.disabled = true;
            switchMode('normal');
        }
        init();

    </script>
</body>
</html>